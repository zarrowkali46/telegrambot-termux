
import json
import random
import os
from telegram import Update, ReplyKeyboardMarkup, KeyboardButton
from telegram.ext import Application, CommandHandler, MessageHandler, ContextTypes, filters

# -------------------------
# CONFIG
# -------------------------
VIDEOS_FILE = "videos.json"
SENT_FILE = "sent.json"
TOKEN = "8463311783:AAFopjKN-6gEPH7WqIZIKvELS16cuG17UQY"

# -------------------------
# Create files if missing
# -------------------------
if not os.path.exists(VIDEOS_FILE):
    sample_data = {
        "videos": [
            {
                "title": "Sample Video 1",
                "url": "https://drive.google.com/file/d/YOUR_FILE_ID_1/view"
            },
            {
                "title": "Sample Video 2", 
                "url": "https://drive.google.com/file/d/YOUR_FILE_ID_2/view"
            }
        ]
    }
    with open(VIDEOS_FILE, "w", encoding="utf-8") as f:
        json.dump(sample_data, f, ensure_ascii=False, indent=2)
    print(f"Created '{VIDEOS_FILE}'. Please add your video links!")

if not os.path.exists(SENT_FILE):
    with open(SENT_FILE, "w", encoding="utf-8") as f:
        json.dump([], f)

# -------------------------
# Load/Save Functions
# -------------------------
def load_videos():
    try:
        with open(VIDEOS_FILE, "r", encoding="utf-8") as f:
            data = json.load(f)
            return data.get("videos", [])
    except (FileNotFoundError, json.JSONDecodeError):
        return []

def load_sent():
    try:
        with open(SENT_FILE, "r", encoding="utf-8") as f:
            return json.load(f)
    except (FileNotFoundError, json.JSONDecodeError):
        return []

def save_sent(data):
    with open(SENT_FILE, "w", encoding="utf-8") as f:
        json.dump(data, f, ensure_ascii=False, indent=2)

# -------------------------
# Keyboard UI
# -------------------------
def menu():
    keyboard = [
        [KeyboardButton("ğŸ² Random"), KeyboardButton("ğŸ“‚ List")],
        [KeyboardButton("ğŸ”„ Reset"), KeyboardButton("ğŸ“Š Stats")]
    ]
    return ReplyKeyboardMarkup(keyboard, resize_keyboard=True)

# -------------------------
# /start command
# -------------------------
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    await update.message.reply_text(
        f"ğŸ‘‹ Welcome {user.first_name}!\n\n"
        "ğŸ¬ Choose an option below:",
        reply_markup=menu()
    )

# -------------------------
# Random Video
# -------------------------
async def random_video(update: Update, context: ContextTypes.DEFAULT_TYPE):
    videos = load_videos()
    
    if not videos:
        await update.message.reply_text(
            f"âŒ No videos found in '{VIDEOS_FILE}'!\n\n"
            "Please add video links in the JSON file."
        )
        return
    
    sent = load_sent()
    remaining = [v for v in videos if v["url"] not in sent]
    
    if not remaining:
        await update.message.reply_text(
            "ğŸ‰ All videos completed!\n\n"
            "â™»ï¸ Resetting playlist..."
        )
        save_sent([])
        remaining = videos
    
    chosen = random.choice(remaining)
    
    try:
        # Send as text with clickable link
        message = (
            f"ğŸ¬ *{chosen['title']}*\n\n"
            f"ğŸ”— [Click here to watch]({chosen['url']})\n\n"
            f"ğŸ“Š Remaining: {len(remaining)-1}/{len(videos)}"
        )
        
        await update.message.reply_text(
            message,
            parse_mode="Markdown",
            disable_web_page_preview=False
        )
        
        sent.append(chosen["url"])
        save_sent(sent)
        
    except Exception as e:
        await update.message.reply_text(f"âŒ Error: {str(e)}")

# -------------------------
# Video List
# -------------------------
async def video_list(update: Update, context: ContextTypes.DEFAULT_TYPE):
    videos = load_videos()
    
    if not videos:
        await update.message.reply_text(f"âŒ No videos found in '{VIDEOS_FILE}'!")
        return
    
    sent = load_sent()
    
    text = "ğŸ“‚ *Video List:*\n\n"
    
    for i, v in enumerate(videos[:20], 1):
        status = "âœ…" if v["url"] in sent else "â¬œ"
        text += f"{i}. {status} {v['title']}\n"
    
    if len(videos) > 20:
        text += f"\n... and {len(videos) - 20} more videos"
    
    text += f"\n\nğŸ“Š Total: {len(videos)}"
    text += f"\nâœ… Watched: {len(sent)}"
    text += f"\nâ¬œ Remaining: {len(videos) - len(sent)}"
    
    await update.message.reply_text(text, parse_mode="Markdown")

# -------------------------
# Reset Progress
# -------------------------
async def reset_progress(update: Update, context: ContextTypes.DEFAULT_TYPE):
    save_sent([])
    await update.message.reply_text(
        "â™»ï¸ Playlist reset complete!\n\n"
        "Starting fresh from the beginning."
    )

# -------------------------
# Stats
# -------------------------
async def stats(update: Update, context: ContextTypes.DEFAULT_TYPE):
    videos = load_videos()
    sent = load_sent()
    
    total = len(videos)
    sent_count = len(sent)
    remaining = total - sent_count
    
    percentage = (sent_count / total * 100) if total > 0 else 0
    
    text = (
        "ğŸ“Š *Statistics:*\n\n"
        f"ğŸ“ Total videos: {total}\n"
        f"âœ… Watched: {sent_count}\n"
        f"â¬œ Remaining: {remaining}\n"
        f"ğŸ“ˆ Progress: {percentage:.1f}%"
    )
    
    await update.message.reply_text(text, parse_mode="Markdown")

# -------------------------
# Router
# -------------------------
async def router(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text
    
    if text == "ğŸ² Random":
        await random_video(update, context)
    elif text == "ğŸ“‚ List":
        await video_list(update, context)
    elif text == "ğŸ”„ Reset":
        await reset_progress(update, context)
    elif text == "ğŸ“Š Stats":
        await stats(update, context)
    else:
        await update.message.reply_text(
            "â“ Please use the buttons below.",
            reply_markup=menu()
        )

# -------------------------
# Main
# -------------------------
def main():
    print("Starting bot...")
    
    # Check videos
    videos = load_videos()
    print(f"Loaded {len(videos)} videos from {VIDEOS_FILE}")
    
    if len(videos) == 0 or videos[0]["url"].startswith("https://drive.google.com/file/d/YOUR_FILE_ID"):
        print(f"\nâš ï¸  Warning: Please edit '{VIDEOS_FILE}' and add your real video links!")
    
    # Create application
    app = Application.builder().token(TOKEN).build()
    
    # Add handlers
    app.add_handler(CommandHandler("start", start))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, router))
    
    # Start bot
    print("âœ… Bot is running! Press Ctrl+C to stop.")
    app.run_polling(allowed_updates=Update.ALL_TYPES)

if __name__ == "__main__":
    main()
